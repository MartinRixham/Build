#! /bin/bash

set -Eeuo pipefail

RECIPE=recipe.json

map()
{
	while read line; do
		$@ $line
	done
}

parmap()
{
	while read line; do
		$@ $line &
	done
	wait
}

filter()
{
	while read line; do
		if $($@ $line > /dev/null); then
			echo $line
		fi
	done
}

not()
{
	while read line; do
		if ! $($@ $line > /dev/null); then
			echo $line
		fi
	done
}

verbose()
{
	echo $@
	$@
}

all()
{
	echo $(cat)
}

clean()
{
	rm -rf build
}

get_sources()
{
	find $1 -name *.c
}

get_link()
{
	echo -l$@
}

get_links()
{
	$JQ -c .dependencies $RECIPE | $JQ -c .[] | $1 | $JQ -r .package | map get_link
}

get_compiler()
{
	$JQ -r .compiler $RECIPE
}

get_name()
{
	$JQ -r .name $RECIPE | echo build/$(cat)
}

object_file()
{
	echo build/$1.o
}

get_output()
{
	echo $1 | tr '.' ' ' | map object_file
}

compile()
{
	verbose $(get_compiler) -c -o $(get_output $1) $1 
}

compile_source()
{
	get_sources src | parmap compile
}

compile_recipe()
{
	jq --version > /dev/null
	JQ=$(which jq)
	mkdir -p build/src
	compile_source
}

without_flags()
{
	echo $1
}

is_executable()
{
	objdump -d $1 | grep "<main>"
}

all_sources()
{
	get_sources src
	get_sources test
}

get_objects()
{
	all_sources | map get_output | not is_executable
}

executable_file()
{
	echo $1
}

get_executable()
{
	echo $1 | tr '.' ' ' | map executable_file
}

link()
{
	verbose $(get_compiler | map without_flags) -o $($2 $3) $(get_objects) $3 $(get_links $1)
}

compile_tests()
{
	get_sources test | parmap compile
}

link_tests()
{
	get_sources test | map get_output | filter is_executable | map link all get_executable
}

run()
{
	$1
}

run_tests()
{
	get_sources test | map get_output | filter is_executable | map get_executable | map run
}

test_recipe()
{
	compile_recipe
	mkdir -p build/test
	compile_tests
	link_tests
	run_tests
}

is_test_dependency()
{
	echo $@ | $JQ .scope | grep test
}

source_dependencies()
{
	not is_test_dependency
}

package_recipe()
{
	test_recipe
	get_sources src | map get_output | filter is_executable | map link source_dependencies get_name
}

run_recipe()
{
	package_recipe
	get_name | map run
}

do_task()
{
	case $1 in
		clean) clean;;
		compile) compile_recipe;;
		test) test_recipe;;
		package) package_recipe;;
		run) run_recipe;;
	esac
}

for task in $@; do
	do_task $task
done
