#! /bin/bash

set -Eeuo pipefail

map()
{
	while read line; do
		echo $line | $@
	done
}

call()
{
	while read line; do
		$@ $line
	done
}

filter()
{
	while read line; do
		if echo $line | $@; then
			echo $line
		fi
	done
}

not()
{
	while read line; do
		if ! echo $line | $@; then
			echo $line
		fi
	done
}

is_installed()
{
	brew ls --versions $(cat) > /dev/null
}

install()
{
	not is_installed | call brew install
}

install_jq()
{
	echo jq | install
	JQ=$(brew --prefix jq)/bin/jq
}

install_dependencies()
{
	$JQ -r .[] | map install
}

make_directories()
{
	mkdir -p build/src
}

compile()
{
	find src -name "*.c" | gcc -Wall $(cat) -o build/src/$1
}

build()
{
	echo $1 | $JQ .dependencies | install_dependencies 
	make_directories
	echo $1 | $JQ -r .name | compile $(cat)
}

make_recipe()
{
	install_jq
	cat $1 | build "$(cat)"
}

make_recipe recipe.json
